# The Last of Guss

Браузерная игра-соревнование, где игроки тапают по виртуальному гусю с мутацией G-42 за очки в течение ограниченных по времени раундов.

## Технологии

### Бэкенд
- Node.js + TypeScript (strict mode)
- Fastify - веб-фреймворк
- Drizzle ORM - работа с базой данных
- PostgreSQL - база данных
- JWT - аутентификация
- bcrypt - хэширование паролей

### Фронтенд
- React + TypeScript (strict mode)
- Vite - сборщик
- React Router - роутинг
- Material-UI (MUI) - UI компоненты
- Zustand - state management
- Axios - HTTP клиент

### Инфраструктура
- Docker Compose
- Nginx - reverse proxy и балансировка нагрузки
- 3 инстанса бэкенда для масштабируемости

## Структура проекта

```
The Last of Guss/
├── backend/                 # Бэкенд приложение
│   ├── src/
│   │   ├── db/             # База данных и схема
│   │   ├── services/       # Бизнес-логика
│   │   ├── routes/         # API роуты
│   │   ├── middleware/     # Middleware
│   │   └── index.ts        # Точка входа
│   ├── package.json
│   ├── tsconfig.json
│   ├── drizzle.config.ts
│   └── Dockerfile
├── frontend/               # Фронтенд приложение
│   ├── src/
│   │   ├── api/           # API клиент и типы
│   │   ├── store/         # State management
│   │   ├── pages/         # Страницы
│   │   ├── components/    # Компоненты
│   │   ├── App.tsx
│   │   └── main.tsx
│   ├── package.json
│   ├── tsconfig.json
│   ├── vite.config.ts
│   └── Dockerfile.dev
├── docker-compose.yml      # Конфигурация Docker Compose
└── nginx.conf             # Конфигурация Nginx
```

## Запуск проекта

### С помощью Docker Compose (рекомендуется)

```bash
# Запуск всех сервисов
docker-compose up

# Приложение будет доступно:
# - Фронтенд: http://localhost:5173
# - API: http://localhost:3001
```

### Локальная разработка

#### Бэкенд

```bash
cd backend
npm install
npm run db:push  # Применить схему к базе данных
npm run dev      # Запуск в режиме разработки
```

#### Фронтенд

```bash
cd frontend
npm install
npm run dev      # Запуск в режиме разработки
```

## Переменные окружения

### Бэкенд (.env)

```env
ROUND_DURATION=60           # Длительность раунда в секундах
COOLDOWN_DURATION=30        # Время cooldown перед стартом в секундах
DATABASE_URL=postgresql://postgres:postgres@localhost:5432/guss_game
JWT_SECRET=your-secret-key
PORT=3001
FRONTEND_URL=http://localhost:5173
```

## Правила игры

- **1 тап = 1 очко**, каждый **11-й тап дает 10 очков**
- Тапать можно только в рамках **активного раунда**
- Активный раунд - тот, который уже начался, но еще не закончился

## Роли пользователей

- **survivor** (выживший) - обычный игрок, может тапать
- **nikita** - особая роль для пользователя "Никита", тапы не считаются (в статистике нули)
- **admin** - администратор, может создавать раунды

Роли назначаются автоматически при регистрации на основе имени пользователя.

## API Endpoints

### Аутентификация
- `POST /api/auth/login` - Логин/регистрация
- `POST /api/auth/logout` - Выход
- `GET /api/auth/me` - Получение информации о текущем пользователе

### Раунды
- `GET /api/rounds` - Список раундов
- `POST /api/rounds` - Создание раунда (только admin)
- `GET /api/rounds/:id` - Детали раунда

### Тапы
- `POST /api/rounds/:id/tap` - Тап по гусю

## Особенности реализации

### Обработка Race Conditions

Для предотвращения race conditions при одновременных тапах используется:
- PostgreSQL транзакции
- Блокировка строк (`SELECT FOR UPDATE`)
- Атомарные операции обновления

Это обеспечивает корректный подсчет очков даже при работе с несколькими инстансами бэкенда.

### Масштабируемость

Приложение спроектировано для работы с несколькими инстансами бэкенда:
- Nginx балансирует нагрузку между 3 инстансами
- Все инстансы используют одну базу данных
- JWT токены в cookies позволяют работать с любым инстансом
- Транзакции БД обеспечивают консистентность данных

## Тестирование

### Тест аутентификации
1. Откройте http://localhost:5173
2. Введите username "admin" и пароль "test123"
3. Должен произойти редирект на страницу раундов

### Тест создания раунда
1. Войдите как admin
2. Нажмите "Создать раунд"
3. Должен произойти редирект на страницу нового раунда

### Тест тапов
1. Дождитесь активации раунда
2. Кликайте по гусю
3. Очки должны увеличиваться (1 за тап, 10 за каждый 11-й)

### Тест роли Никиты
1. Выйдите и войдите как "Никита"
2. Тапайте в активном раунде
3. Очки должны оставаться 0

## Лицензия

MIT
